# Workflow ì´ë¦„
name: Build and Push Frontend & Backend Images

# Github infra ë¸Œëžœì¹˜ì˜ VERSION íŒŒì¼ì´ ìˆ˜ì •ë˜ì—ˆì„ ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
on:
  push:
    branches: [ infra ]
    paths:
      - 'VERSION'

# ì›Œí¬í”Œë¡œìš°ê°€ Gitì— ë‹¤ì‹œ Pushí•  ìˆ˜ ìžˆë„ë¡ ê¶Œí•œ ë¶€ì—¬
permissions:
  contents: write

# í™˜ê²½ë³€ìˆ˜ ì •ì˜
env:
  ACR_NAME: tetrisgameacr
  BACKEND_IMAGE_REPO: tetris-backend
  FRONTEND_IMAGE_REPO: tetris-frontend
  RESOURCE_GROUP: tetrisgame-rg
  AKS_CLUSTER: tetrisgame-aks

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      # 2. Azure CLI ë¡œê·¸ì¸
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3. ì´ë¯¸ì§€ íƒœê·¸ ì„¤ì • (ê³µìš© VERSION íŒŒì¼ ì‚¬ìš©)
      - name: Set image tag
        id: set-image-tag
        run: |
          IMAGE_TAG=$(cat VERSION)
          if [ -z "$IMAGE_TAG" ]; then
            echo "Error: VERSION file is empty or does not exist."
            exit 1
          fi
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
      
      # 4. ACRì— ë¡œê·¸ì¸
      - name: Login to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
          password: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

      # 5-1. ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push backend image
        run: |
          docker build ./src/back-end -f ./src/back-end/Dockerfile -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.BACKEND_IMAGE_REPO }}:${{ steps.set-image-tag.outputs.IMAGE_TAG }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.BACKEND_IMAGE_REPO }}:${{ steps.set-image-tag.outputs.IMAGE_TAG }}

      # 5-2. í”„ë¡ íŠ¸ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push frontend image
        run: |
          docker build ./src/front-end -f ./src/front-end/Dockerfile -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.FRONTEND_IMAGE_REPO }}:${{ steps.set-image-tag.outputs.IMAGE_TAG }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.FRONTEND_IMAGE_REPO }}:${{ steps.set-image-tag.outputs.IMAGE_TAG }}

      # 6. AKS í´ëŸ¬ìŠ¤í„° ì—°ê²°
      - name: Set up AKS context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER }}

      # 7. Key Vault ë° AKS Identity ì •ë³´ ìˆ˜ì§‘
      - name: Collect Azure resource information
        id: collect-info
        run: |
          # AKS Key Vault Secrets Provider Identity ì •ë³´
          IDENTITY_CLIENT_ID=$(az aks show -g ${{ env.RESOURCE_GROUP }} -n ${{ env.AKS_CLUSTER }} --query addonProfiles.azureKeyvaultSecretsProvider.identity.clientId -o tsv)
          IDENTITY_OBJECT_ID=$(az aks show -g ${{ env.RESOURCE_GROUP }} -n ${{ env.AKS_CLUSTER }} --query addonProfiles.azureKeyvaultSecretsProvider.identity.objectId -o tsv)
          
          # Key Vault ì •ë³´
          KEY_VAULT_NAME=$(az keyvault list -g ${{ env.RESOURCE_GROUP }} --query '[0].name' -o tsv)
          KEY_VAULT_ID=$(az keyvault show -n $KEY_VAULT_NAME -g ${{ env.RESOURCE_GROUP }} --query id -o tsv)
          
          # í…Œë„ŒíŠ¸ ID
          TENANT_ID=$(az account show --query tenantId -o tsv)
          
          # GitHub Actions ì¶œë ¥ìœ¼ë¡œ ì„¤ì •
          echo "IDENTITY_CLIENT_ID=${IDENTITY_CLIENT_ID}" >> $GITHUB_OUTPUT
          echo "IDENTITY_OBJECT_ID=${IDENTITY_OBJECT_ID}" >> $GITHUB_OUTPUT
          echo "KEY_VAULT_NAME=${KEY_VAULT_NAME}" >> $GITHUB_OUTPUT
          echo "KEY_VAULT_ID=${KEY_VAULT_ID}" >> $GITHUB_OUTPUT
          echo "TENANT_ID=${TENANT_ID}" >> $GITHUB_OUTPUT
          
          echo "âœ… ìˆ˜ì§‘ëœ ì •ë³´:"
          echo "  - Identity Client ID: ${IDENTITY_CLIENT_ID}"
          echo "  - Key Vault Name: ${KEY_VAULT_NAME}"
          echo "  - Tenant ID: ${TENANT_ID}"

      # 8. Key Vault ê¶Œí•œ ì„¤ì •
      - name: Set Key Vault permissions
        run: |
          # Key Vault Secrets User ì—­í•  í™•ì¸
          EXISTING_ROLE=$(az role assignment list \
            --assignee ${{ steps.collect-info.outputs.IDENTITY_OBJECT_ID }} \
            --scope ${{ steps.collect-info.outputs.KEY_VAULT_ID }} \
            --query "[?roleDefinitionName=='Key Vault Secrets User'].roleDefinitionName" -o tsv)
          
          if [ -z "$EXISTING_ROLE" ]; then
            echo "âš ï¸  Key Vault ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤..."
            az role assignment create \
              --role "Key Vault Secrets User" \
              --assignee ${{ steps.collect-info.outputs.IDENTITY_OBJECT_ID }} \
              --scope ${{ steps.collect-info.outputs.KEY_VAULT_ID }}
            echo "âœ… Key Vault ê¶Œí•œ ë¶€ì—¬ ì™„ë£Œ!"
          else
            echo "âœ… Key Vault ê¶Œí•œì´ ì´ë¯¸ ì„¤ì •ë˜ì–´ ìžˆìŠµë‹ˆë‹¤."
          fi

      # 9. SecretProviderClass ìžë™ ìƒì„± ë° ë°°í¬
      - name: Generate and deploy SecretProviderClass
        run: |
          # SecretProviderClass YAML íŒŒì¼ ìƒì„±
          cat > k8s-manifests/secret-provider-class.yaml << EOF
          apiVersion: secrets-store.csi.x-k8s.io/v1
          kind: SecretProviderClass
          metadata:
            name: azure-kv-tetris-secrets
            namespace: default
          spec:
            provider: azure
            parameters:
              usePodIdentity: "false"
              useVMManagedIdentity: "true"
              userAssignedIdentityID: "${{ steps.collect-info.outputs.IDENTITY_CLIENT_ID }}"
              keyvaultName: "${{ steps.collect-info.outputs.KEY_VAULT_NAME }}"
              tenantId: "${{ steps.collect-info.outputs.TENANT_ID }}"
              objects: |
                array:
                  - |
                    objectName: postgresql-url
                    objectType: secret
                    objectAlias: postgresql-url
                  - |
                    objectName: redis-host
                    objectType: secret
                    objectAlias: redis-host
                  - |
                    objectName: redis-pass
                    objectType: secret
                    objectAlias: redis-pass
                  - |
                    objectName: jwt-secret
                    objectType: secret
                    objectAlias: jwt-secret
                  - |
                    objectName: refresh-token-secret
                    objectType: secret
                    objectAlias: refresh-token-secret
            secretObjects:
            - secretName: app-secrets
              type: Opaque
              data:
              - objectName: postgresql-url
                key: postgresql-url
              - objectName: redis-host
                key: redis-host
              - objectName: redis-pass
                key: redis-pass
              - objectName: jwt-secret
                key: jwt-secret
              - objectName: refresh-token-secret
                key: refresh-token-secret
          EOF
          
          echo "âœ… SecretProviderClass YAML íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
          
          # Kubernetesì— ì ìš©
          kubectl apply -f k8s-manifests/secret-provider-class.yaml
          echo "âœ… SecretProviderClassê°€ Kubernetesì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!"

      # 10. Git ì„¤ì • ë° YAML íŒŒì¼ë“¤ ì—…ë°ì´íŠ¸
      - name: Update Kubernetes manifests
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
          sed -i "s|image: ${{ env.ACR_NAME }}.azurecr.io/${{ env.BACKEND_IMAGE_REPO }}:.*|image: ${{ env.ACR_NAME }}.azurecr.io/${{ env.BACKEND_IMAGE_REPO }}:${{ steps.set-image-tag.outputs.IMAGE_TAG }}|g" k8s-manifests/backend-deployment.yaml
          sed -i "s|image: ${{ env.ACR_NAME }}.azurecr.io/${{ env.FRONTEND_IMAGE_REPO }}:.*|image: ${{ env.ACR_NAME }}.azurecr.io/${{ env.FRONTEND_IMAGE_REPO }}:${{ steps.set-image-tag.outputs.IMAGE_TAG }}|g" k8s-manifests/frontend-deployment.yaml

      # 11. ë³€ê²½ëœ YAML íŒŒì¼ë“¤ì„ main ë¸Œëžœì¹˜ì— ë‹¤ì‹œ Push
      - name: Commit and push manifest changes
        run: |
          git add k8s-manifests/secret-provider-class.yaml
          git diff --quiet || (git commit -am "chore(ci): Update image tags to ${{ steps.set-image-tag.outputs.IMAGE_TAG }} and SecretProviderClass" && git push)

      # 12. ë°°í¬ ìƒíƒœ í™•ì¸
      - name: Verify deployment
        run: |
          echo "ðŸ” ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
          
          # SecretProviderClass ìƒíƒœ í™•ì¸
          kubectl describe secretproviderclass azure-kv-tetris-secrets || echo "âš ï¸ SecretProviderClass í™•ì¸ ì‹¤íŒ¨"
          
          # Key Vault Secrets Store CSI Driver Pod ìƒíƒœ í™•ì¸
          kubectl get pods -n kube-system -l app=secrets-store-csi-driver || echo "âš ï¸ CSI Driver Pod í™•ì¸ ì‹¤íŒ¨"
          
          echo "âœ… ë°°í¬ ì™„ë£Œ! ArgoCDì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë™ê¸°í™”ë¥¼ í™•ì¸í•˜ì„¸ìš”."
